name: Build Windows Installer

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      app_version:
        description: "Installer version"
        required: true
        default: "1.0.0"

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.4xx"

      - name: Show dotnet info
        shell: powershell
        run: |
          dotnet --version
          dotnet --info

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup --no-progress -y

      - name: Build installer
        shell: powershell
        run: |
          Set-StrictMode -Version Latest
          $version = "${{ github.event.inputs.app_version }}"
          powershell -ExecutionPolicy Bypass -File "windows/installer/build-installer.ps1" -AppVersion $version

      - name: Capture offline runtime debug (always)
        if: always()
        shell: powershell
        run: |
          Set-StrictMode -Version Latest
          $debugDir = "windows/dist/debug"
          New-Item -ItemType Directory -Force -Path $debugDir | Out-Null
          $runtimeRoot = "windows/dist/offline-runtime"
          if (Test-Path $runtimeRoot) {
            Get-ChildItem -Path $runtimeRoot -Recurse -Force |
              Select-Object FullName, Length, LastWriteTime |
              Out-File -FilePath (Join-Path $debugDir "offline-runtime-tree.txt") -Encoding utf8
            $keyFiles = @(
              "python\\Lib\\site-packages\\argostranslate\\__init__.py",
              "python\\Lib\\site-packages\\argostranslate\\translate.py",
              "python\\Lib\\site-packages\\argostranslate\\package.py",
              "python\\Lib\\site-packages\\ctranslate2\\__init__.py",
              "python\\ctranslate2\\__init__.py",
              "python\\Lib\\site-packages\\sentencepiece\\__init__.py",
              "python\\sentencepiece\\__init__.py",
              "offline-site-packages.zip"
            )
            foreach ($rel in $keyFiles) {
              $path = Join-Path $runtimeRoot $rel
              "$rel => $(Test-Path $path)" | Out-File -FilePath (Join-Path $debugDir "offline-runtime-key-files.txt") -Encoding utf8 -Append
            }
            $ct2Pyd = Get-ChildItem -Path (Join-Path $runtimeRoot "python\\Lib\\site-packages\\ctranslate2") -Filter "*.pyd" -File -ErrorAction SilentlyContinue | Select-Object -First 1
            "python\\Lib\\site-packages\\ctranslate2\\*.pyd => $([bool]$ct2Pyd)" | Out-File -FilePath (Join-Path $debugDir "offline-runtime-key-files.txt") -Encoding utf8 -Append
            $ct2RootPyd = Get-ChildItem -Path (Join-Path $runtimeRoot "python\\ctranslate2") -Filter "*.pyd" -File -ErrorAction SilentlyContinue | Select-Object -First 1
            "python\\ctranslate2\\*.pyd => $([bool]$ct2RootPyd)" | Out-File -FilePath (Join-Path $debugDir "offline-runtime-key-files.txt") -Encoding utf8 -Append
          } else {
            "offline-runtime not found: $runtimeRoot" | Out-File -FilePath (Join-Path $debugDir "offline-runtime-tree.txt") -Encoding utf8
          }

      - name: Locate installer
        id: locate
        shell: powershell
        run: |
          $version = "${{ github.event.inputs.app_version }}"
          $expected = "windows/dist/installer/TripleSpaceTranslator-Setup-$version.exe"
          if (Test-Path $expected) {
            $installer = $expected
          } else {
            $candidate = Get-ChildItem -Path windows -Recurse -File -Filter "TripleSpaceTranslator-Setup-*.exe" |
              Sort-Object LastWriteTime -Descending |
              Select-Object -First 1

            if (-not $candidate) {
              Write-Host "Installer not found. Debug listing:" -ForegroundColor Red
              Get-ChildItem -Path windows -Recurse | Select-Object FullName
              throw "Installer not found under windows/**"
            }

            $installer = $candidate.FullName
          }
          "installer_path=$installer" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: TripleSpaceTranslator-Setup-${{ github.event.inputs.app_version }}
          path: |
            ${{ steps.locate.outputs.installer_path }}
            windows/dist/installer/TripleSpaceTranslator-win-x86.exe
            windows/dist/installer/TripleSpaceTranslator-win-x64.exe
            windows/dist/installer/TripleSpaceTranslator-win-arm64.exe
          if-no-files-found: error
          retention-days: 30

      - name: Upload debug artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-offline-runtime-debug-${{ github.event.inputs.app_version }}
          path: windows/dist/debug/*
          if-no-files-found: warn
          retention-days: 30

      - name: Publish GitHub Release asset
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ github.event.inputs.app_version }}
          name: TripleSpaceTranslator v${{ github.event.inputs.app_version }}
          allowUpdates: true
          artifacts: ${{ steps.locate.outputs.installer_path }}
          replacesArtifacts: true
          generateReleaseNotes: true
